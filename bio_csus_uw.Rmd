---
title: "bio_csus_uw"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE}
#install.packages("")
```

```{r, include = FALSE}
library(purrr)
library(scales)
library(plyr)
library(readtext)
library(stringr)
library(quanteda)
library(ggfortify)
library(FactoMineR)
library(factoextra)
library(openxlsx)
library(alluvial)
library(ggalluvial)
library(data.table)
library(ggrepel)
library(ggfittext)
```

This is an exploratory document intended to be used as 'scratch paper' for data analysis. Some of the code is left in for imitation as may be necessary. The comments throughout are meant to explain code choices and data summaries. Happy reading!

```{r, warning = FALSE}
### IMPORT DATA/CREATE SUBSETS  ###
###################################

data_wk2 <- readtext("/Users/ryanharris/Downloads/Bio2_Sp21_Week2_Survey_JM_RH.xlsx")
data_wk14 <- readtext("/Users/ryanharris/Downloads/Bio2_Sp21_Week14_Survey_JM_RH.xlsx")
data_wk14
## data_alv comes from a file created outside of R, included file (merged.xlsx) with rmd email
data_alv <- readtext("/Users/ryanharris/Desktop/merged.xlsx")

## each of the readtext() functions above are path specific to my machine
## to imitate, use data <- readtext("/path_to_files/data.xslx")

subset_wk2 <- data_wk2[ -c(1:3) ]
subset_wk14 <- data_wk14[ -c(1) ]

colnames(subset_wk2) <- c("Participant.ID", "q1.2", "q2.2", "q3.2", "lecture")
colnames(subset_wk14) <- c("Participant.ID", "q1.14", "q2.14", "q3.14", "lecture")

merged_data <- merge(subset_wk2, subset_wk14, by.x = "Participant.ID", by.y = "Participant.ID")
merged_data <- merged_data[ -c(9) ]

data_alv <- data_alv[-c(1)]
colnames(data_alv) <- c("Participant.ID", "survey", "q1", "q2", "q3", "lecture")
```

```{r, warning = FALSE}
## replace column values with numbers for easier data visuals

likert_num2 <- revalue(merged_data$q2.2, c("agree" = 5, "somewhat agree" = 4, "I don't know" = 3, "somewhat disagree" = 2, "disagree" = 1))
likert_num14 <- revalue(merged_data$q2.14, c("agree" = "5", "somewhat agree" = "4", "I don't know" = "3", "somewhat disagree" = "2", "disagree" = "1"))

response <- c("disagree", "somewhat disagree", "I don't know", "somewhat agree", "agree")
value <- 1:5

## note that the values relate as follows:
data.frame(response,value)

merged_data <- merged_data[ -c(3, 7) ] ##these columns will be replaced with numbers
likert <- cbind(merged_data, likert_num2, likert_num14)

likert_cols <- likert[ -c(1,2,3,4,5,6) ]
likert_num <- data.frame(lapply(likert_cols,as.numeric))

likert_num$difference <- likert_num$likert_num14 - likert_num$likert_num2
likert <- cbind(likert, likert_num$difference)

colnames(likert) <- c("Participant.ID", "q1.2", "q3.2", "lecture.x", "q1.14", "q3.14", "likert_num2", "likert_num14", "difference")
col_order <- c("Participant.ID", "q1.2", "likert_num2", "q3.2", "lecture.x", "q1.14", "likert_num14", "q3.14", "difference")
likert <- likert[, col_order]
```

```{r, warning = FALSE}
## this is a more efficient way to create the subsets requested

increasing <- likert[ !(likert$difference <= 0 ), ]
#write.xlsx(increasing, file = "increasing")
decreasing <- likert[ !(likert$difference >= 0 ), ]
#write.xlsx(decreasing, file = "decreasing")
omit_2agree <- likert[ !(likert$difference == 0 & likert_num2 == 5 ), ]
#write.xlsx(omit_2agree, file = "no_both_agree")
```

```{r, warning = FALSE}
### FOR SUMMARY STATS ###
#########################

drops <- c("Participant.ID", "q1.2", "q3.2", "q1.14", "q3.14", "difference")
increasing_num <- increasing[ , !(names(increasing) %in% drops)]
decreasing_num <- decreasing[ , !(names(decreasing) %in% drops)]
omit2_num <- omit_2agree[ , !(names(omit_2agree) %in% drops)]

increasing_num <- data.frame(lapply(increasing,as.numeric))
decreasing_num <- data.frame(lapply(decreasing,as.numeric))
omit_2agree_num <- data.frame(lapply(omit_2agree,as.numeric))
```

Note that the difference represents the direction and magnitude of change between survey responses for week 2 and week 14. Note that the magnitude is not applicable for any reason other than recording the number of decisions between each survey choice + 1. For example, if a participant responds "somewhat disagree" in week 2 and "agree" in week 14, then the difference is 5 - 2 = 3. A negative value indicates a participant going in the opposite direction (like from "somewhat agree" to "I don't know", for example).

```{r}
### SUMMARY STATS AND FREQUENCY DIAGRAMS  ###
#############################################

### TOTAL SUMMARY ###
summary(likert_num)
ggplot(likert_num) +
  geom_bar(aes(likert_num2))
ggplot(likert_num) +
  geom_bar(aes(likert_num14))
ggplot(likert_num) +
  geom_bar(aes(difference)) +
  scale_x_continuous(breaks = pretty_breaks())

col_n <- c(3,7,9)

### OMIT 2 AGREE SUMMARY  ###
omit_sum <- omit_2agree_num[,col_n]
summary(omit_sum)
ggplot(omit_sum) +
  geom_bar(aes(likert_num2))
ggplot(omit_sum) +
  geom_bar(aes(likert_num14))
ggplot(omit_sum) +
  geom_bar(aes(difference)) +
  scale_x_continuous(breaks = pretty_breaks())

### INCREASING SUMMARY  ###
increasing_sum <- increasing_num[,col_n]
summary(increasing_sum)
ggplot(omit_sum) +
  geom_bar(aes(likert_num2))
ggplot(omit_sum) +
  geom_bar(aes(likert_num14))
ggplot(omit_sum) +
  geom_bar(aes(difference)) +
  scale_x_continuous(breaks = pretty_breaks())

### DECREASING SUMMARY  ###
decreasing_sum <- decreasing_num[,col_n]
summary(decreasing_sum)
ggplot(decreasing_sum) +
  geom_bar(aes(likert_num2))
ggplot(decreasing_sum) +
  geom_bar(aes(likert_num14))
```

This first alluvial diagram uses the CRAN package that was discussed during our interview. I found this was much more difficult to work with compared to using the ggplot version.

```{r}
### ALLUVIAL DIAGRAMS ###
#########################

## using alluvial
drops <- c("Participant.ID", "q1.2", "q3.2", "q1.14", "q3.14", "difference")
alluvial1 <- omit_2agree[ , !(names(omit_2agree) %in% drops)]
freq_data <- setDT(alluvial1)[,rep(.N,.N),.(likert_num2, lecture.x, likert_num14)]
plot1 <- alluvial(freq_data[,1:3], freq=freq_data$V1)
```

Most of the alluvial diagrams here are very similar. The comment lines above each plot in the code chunk below include information about what is presented in the corresponding images.

The first plot uses only two axes (before and after likert responses). This uses an augmented version of the data that was created outside of R (it was easier to just manipulate directly with excel).

All remaining alluvial diagrams use three axes (the middle axis being the lecture, left and right being the survey responses for weeks 2 and 14, respectively). The image labels and keys are rudimentary - these can be cleaned up as necessary.

```{r, warning = FALSE}
### MERGED/ALV DATA ###
#######################

## two axes, color by lecture
ggplot(data_alv, aes(x = survey, stratum = q2, alluvium = Participant.ID)) +
  geom_alluvium(aes(fill = lecture)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), min.y = 4)
#setting the min.y ensures that the stratum labels don't interfere with the image. In this case, disagree is not labeled in the rightmost axis.

## color by week 14 responses
ggplot(merged_data, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num14)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), min.y = 4)

## color by week 2 responses
ggplot(merged_data, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num2)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by lecture
ggplot(merged_data, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = lecture.x)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))
```


```{r, warning = FALSE}
### MERGED DATA WITHOUT BOTH AGREE  ###
#######################################

## color by week 14 responses
ggplot(alluvial1, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num14)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by week 2 responses
ggplot(alluvial1, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num2)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by lecture
ggplot(alluvial1, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = lecture.x)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))
```

```{r, warning = FALSE}
### INCREASING SUBSET ###
#########################

## color by week 14 responses
ggplot(increasing, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num14)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by week 2 responses
ggplot(increasing, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num2)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by lecture
ggplot(increasing, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = lecture.x)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))
```

```{r, warning = FALSE}
### DECREASING SUBSET ###
#########################

## color by week 14 responses
ggplot(decreasing, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num14)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by week 2 responses
ggplot(decreasing, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = likert_num2)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))

## color by lecture
ggplot(decreasing, aes(axis1 = likert_num2, axis2 = lecture.x, axis3 = likert_num14)) +
  geom_alluvium(aes(fill = lecture.x)) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)))
```

The following is used to create a document term matrix (DTM) for the free response survey questions in both weeks.

```{r, warning = FALSE}
### CREATE DTM  ###
###################

# data5 <- data_wk2[, 5]
# data5_corp <- corpus(data5)
# dtm5 <- dfm(data5_corp, tolower = TRUE, remove_punct = TRUE, stem = TRUE, remove = stopwords("english"))
# dtm5freq <- docfreq(dtm5)
# dtm5 <- dtm5[, dtm5freq >= 2]
# 
# data7 <- data_wk2[, 7]
# data7_corp <- corpus(data7)
# dtm7 <- dfm(data7_corp, tolower = TRUE, remove_punct = TRUE, stem = TRUE, remove = stopwords("english"))
# dtm7freq <- docfreq(dtm7)
# dtm7 <- dtm7[, dtm7freq >= 2]
# 
# data5_14 <- data_wk14[, 3]
# data5_14_corp <- corpus(data5_14)
# dtm5_14 <- dfm(data5_14_corp, tolower = TRUE, remove_punct = TRUE, stem = TRUE, remove = stopwords("english"))
# dtm5_14freq <- docfreq(dtm5_14)
# dtm5_14 <- dtm5_14[, dtm5_14freq >= 2]
# 
# data7.14 <- data_wk14[, 5]
# data7.14_corp <- corpus(data7.14)
# dtm7.14 <- dfm(data7.14_corp, tolower = TRUE, remove_punct = TRUE, stem = TRUE, remove = stopwords("english"))
# dtm7.14freq <- docfreq(dtm7.14)
# dtm7.14 <- dtm7.14[, dtm7_14freq >= 2]
```

```{r}
### DICTIONARY AND COUNTING ###
###############################

#download.file("http://bit.ly/37cV95h", tf <- tempfile())
#myDict <- dictionary(file = tf, format = "LIWC")
#dict_dtm5 <- dfm_lookup(dtm5, myDict, nomatch = "_unmatched")
#dict_dtm5

#dict_dtm7 <- dfm_lookup(dtm7, myDict, nomatch = "_unmatched")
#dict_dtm7
```
